<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Pro Viewer v1.4.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --google-blue: #4285f4;
            --google-red: #ea4335;
            --bg-color: #f8f9fa;
            --border-color: #dadce0;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; }
        .container { max-width: 1500px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); padding: 20px; margin-bottom: 20px; }
        
        .config-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .main-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; margin-top: 20px; }
        .scroll-area { height: 500px; border: 1px solid var(--border-color); border-radius: 8px; overflow-y: auto; background: white; }

        /* 포인트 리스트 아이템 */
        .point-list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .point-list-item:hover { background: #f1f3f4; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; }
        .badge-path { background: var(--google-blue); }
        .badge-visit { background: var(--google-red); }

        /* 지도 아이콘 */
        .number-icon { background: white; border: 2px solid var(--google-blue); border-radius: 50%; color: var(--google-blue); font-weight: bold; text-align: center; font-size: 10px; line-height: 18px; }
        .number-icon.visit { border-color: var(--google-red); color: var(--google-red); box-shadow: 0 0 8px rgba(234, 67, 53, 0.5); }

        #map { height: 600px; border-radius: 12px; border: 1px solid var(--border-color); }
        textarea { width: 100%; height: 250px; background: #202124; color: #e8eaed; font-family: monospace; font-size: 11px; padding: 10px; border-radius: 8px; box-sizing: border-box; }
        
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-primary { background: var(--google-blue); color: white; width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="text-align:center;">
        <h2 style="margin:0;">Timeline Pro Viewer <span style="color:var(--google-red);">v1.4.0</span></h2>
        <p style="color:gray;">날짜별 KML 분리 및 POI(Visit) 내보내기 모드</p>
        <input type="file" id="fileInput" accept=".json">
    </div>

    <div id="selectionSection" class="hidden">
        <div class="config-grid">
            <div class="card">
                <h4 style="margin-top:0;">1. 날짜 리스트</h4>
                <div id="dateList" class="scroll-area" style="height:300px;"></div>
            </div>
            <div class="card">
                <h4>2. 필터 설정</h4>
                <div style="margin-bottom:15px; background:#eee; padding:15px; border-radius:8px;">
                    <input type="date" id="startDate"> ~ <input type="date" id="endDate">
                    <label style="margin-left:20px;"><input type="checkbox" id="showMarkers" checked onchange="reIndexAndRender()"> 순번 표시</label>
                </div>
                <button class="btn btn-primary" onclick="processData()">분석 및 시각화 시작</button>
            </div>
        </div>
    </div>

    <div id="resultSection" class="hidden">
        <div class="main-grid">
            <div class="card"><div id="map"></div></div>
            <div class="card">
                <h4 style="margin:0 0 10px 0;">Sequence List</h4>
                <div id="pointList" class="scroll-area" style="height:550px;"></div>
            </div>
        </div>

        <div class="config-grid" style="margin-top:20px;">
            <div class="card">
                <h4>KML (Date-separated POI & Path)</h4>
                <textarea id="kmlOutput" readonly></textarea>
                <button class="btn" style="background:#34a853; color:white; width:100%; margin-top:10px;" onclick="downloadKML()">KML 다운로드</button>
            </div>
            <div class="card">
                <h4>Filtered Raw Data (JSON)</h4>
                <textarea id="jsonOutput" readonly></textarea>
            </div>
        </div>
    </div>
</div>

<script>
    let rawJsonData = [];
    let currentPoints = []; 
    let filteredRaw = [];   
    let map, pathLayer, markerLayer;

    // 파일 입력 처리
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const json = JSON.parse(event.target.result);
                rawJsonData = json.semanticSegments || (Array.isArray(json) ? json : []);
                buildDateList();
            } catch (err) { alert("파일 파싱 실패"); }
        };
        reader.readAsText(file);
    });

    // 날짜별 세그먼트 수 요약 리스트
    function buildDateList() {
        const dateMap = new Map();
        rawJsonData.forEach(item => {
            const time = item.startTime || (item.visit && item.visit.startTime);
            if (time) {
                const d = time.split('T')[0];
                dateMap.set(d, (dateMap.get(d) || 0) + 1);
            }
        });
        const sortedDates = Array.from(dateMap.keys()).sort().reverse();
        const listEl = document.getElementById('dateList');
        listEl.innerHTML = '';
        sortedDates.forEach(date => {
            const div = document.createElement('div');
            div.className = 'point-list-item';
            div.innerHTML = `<b>${date}</b> <small>(${dateMap.get(date)})</small>`;
            div.onclick = () => {
                document.getElementById('startDate').value = date;
                document.getElementById('endDate').value = date;
                document.querySelectorAll('.point-list-item').forEach(el => el.style.background = 'none');
                div.style.background = '#e8f0fe';
            };
            listEl.appendChild(div);
        });
        document.getElementById('selectionSection').classList.remove('hidden');
    }

    // 데이터 분석 프로세스
    function processData() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (!start || !end) return alert("날짜를 설정하세요.");

        const startTS = new Date(start).getTime();
        const endTS = new Date(end).getTime() + 86400000;

        filteredRaw = [];
        currentPoints = [];

        rawJsonData.forEach(item => {
            const itemTime = new Date(item.startTime).getTime();
            if (itemTime >= startTS && itemTime <= endTS) {
                filteredRaw.push(item);
                const dateKey = item.startTime.split('T')[0];

                if (item.visit) {
                    const loc = item.visit.topCandidate?.placeLocation?.latLng || item.visit.location?.latLng;
                    if (loc) {
                        const pts = loc.replace(/[°\s]/g, '').split(',');
                        currentPoints.push({
                            lat: parseFloat(pts[0]), lng: parseFloat(pts[1]),
                            time: item.startTime, date: dateKey, type: 'visit', node: 'visit'
                        });
                    }
                } else if (item.timelinePath) {
                    item.timelinePath.forEach(p => {
                        const pts = p.point.replace(/[°\s]/g, '').split(',');
                        currentPoints.push({
                            lat: parseFloat(pts[0]), lng: parseFloat(pts[1]),
                            time: p.duration?.startTimestamp || item.startTime, date: dateKey, type: 'path', node: 'activitySegment'
                        });
                    });
                }
            }
        });
        reIndexAndRender();
        document.getElementById('resultSection').classList.remove('hidden');
    }

    function reIndexAndRender() {
        currentPoints.forEach((p, i) => p.seq = i + 1);
        renderMap();
        renderPointList();
        updateKMLOutput();
        document.getElementById('jsonOutput').value = JSON.stringify(filteredRaw, null, 2);
    }

    function renderMap() {
        if (!map) {
            map = L.map('map').setView([37.5, 127], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            pathLayer = L.featureGroup().addTo(map);
            markerLayer = L.featureGroup().addTo(map);
        }
        pathLayer.clearLayers();
        markerLayer.clearLayers();

        // 1. Path (Line) 표시 - 날짜별로 따로 그리면 끊길 수 있으므로 전체 Path 필터링하여 연결
        const pathCoords = currentPoints.filter(p => p.type === 'path').map(p => [p.lat, p.lng]);
        if (pathCoords.length > 0) L.polyline(pathCoords, {color: '#4285f4', weight: 4}).addTo(pathLayer);

        // 2. 마커 표시
        if (document.getElementById('showMarkers').checked) {
            currentPoints.forEach(p => {
                const isV = p.type === 'visit';
                const icon = L.divIcon({ className: `number-icon ${isV ? 'visit':''}`, html: p.seq, iconSize: [22, 22] });
                L.marker([p.lat, p.lng], {icon: icon})
                 .bindPopup(`<b>[${isV?'방문':'이동'}] Seq: ${p.seq}</b><br>시간: ${p.time}<br>노드: ${p.node}`)
                 .addTo(markerLayer);
            });
        }
        if (currentPoints.length > 0) map.fitBounds(pathLayer.getBounds().extend(markerLayer.getBounds()));
    }

    function renderPointList() {
        const listEl = document.getElementById('pointList');
        listEl.innerHTML = '';
        currentPoints.forEach((p, index) => {
            const isV = p.type === 'visit';
            const div = document.createElement('div');
            div.className = 'point-list-item';
            div.innerHTML = `
                <div style="background:${isV?'red':'blue'}; color:white; width:25px; text-align:center; border-radius:4px; font-weight:bold;">${p.seq}</div>
                <div style="flex-grow:1; font-size:12px;">
                    <strong>[${isV?'방문':'이동'}]</strong> ${p.time.split('T')[1].substring(0,8)}<br>
                    <small>${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</small>
                </div>
                <button onclick="deletePoint(event, ${index})" style="color:red; border:none; background:none; cursor:pointer;">✕</button>
            `;
            div.onclick = () => map.flyTo([p.lat, p.lng], 16);
            listEl.appendChild(div);
        });
    }

    function deletePoint(e, idx) {
        e.stopPropagation();
        if(confirm(`${idx+1}번 포인트를 삭제하시겠습니까?`)) {
            currentPoints.splice(idx, 1);
            reIndexAndRender();
        }
    }

    // [핵심] KML 생성 로직 - 날짜별 분리 및 POI 처리
    function updateKMLOutput() {
        const dateGroups = {};
        currentPoints.forEach(p => {
            if (!dateGroups[p.date]) dateGroups[p.date] = { paths: [], visits: [] };
            if (p.type === 'path') dateGroups[p.date].paths.push(p);
            else dateGroups[p.date].visits.push(p);
        });

        let kmlFolders = "";
        for (const [date, data] of Object.entries(dateGroups)) {
            kmlFolders += `    <Folder>
      <name>Date: ${date}</name>
      <Placemark>
        <name>Path ${date}</name>
        <styleUrl>#pathStyle</styleUrl>
        <LineString>
          <coordinates>${data.paths.map(p => `${p.lng},${p.lat},0`).join('\n')}</coordinates>
        </LineString>
      </Placemark>
      `;
            
            data.visits.forEach(v => {
                kmlFolders += `
      <Placemark>
        <name>POI Seq ${v.seq} (${v.time.split('T')[1].substring(0,5)})</name>
        <styleUrl>#visitStyle</styleUrl>
        <Point>
          <coordinates>${v.lng},${v.lat},0</coordinates>
        </Point>
      </Placemark>`;
            });
            kmlFolders += `
    </Folder>\n`;
        }

        const kmlFull = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Timeline Export v1.4.0</name>
    <Style id="pathStyle">
      <LineStyle><color>ffdb4242</color><width>4</width></LineStyle>
    </Style>
    <Style id="visitStyle">
      <IconStyle>
        <color>ff0000ff</color>
        <scale>1.1</scale>
        <Icon><href>http://maps.google.com/mapfiles/kml/paddle/red-circle.png</href></Icon>
      </IconStyle>
    </Style>
${kmlFolders}
  </Document>
</kml>`;
        document.getElementById('kmlOutput').value = kmlFull;
    }

    function downloadKML() {
        const blob = new Blob([document.getElementById('kmlOutput').value], {type: 'application/vnd.google-earth.kml+xml'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `timeline_v140_POI.kml`;
        a.click();
    }
</script>
</body>
</html>